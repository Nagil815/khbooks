<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="book">

	<resultMap type="dto.BookDTO" id="book_and_author" autoMapping="false" >
		<result column="bno" property="bno" />
		<result column="bname" property="bname" />
		<result column="gno" property="gno" />
		<result column="bupdate" property="bupdate" />
		<result column="bgrade" property="bgrade" />
		<result column="bview" property="bview" />
		<result column="bthumb" property="bthumb" />
		<result column="binfo" property="binfo" />
		<collection property="aList" javaType="java.util.List"
			ofType="dto.AuthorDTO"  autoMapping="false" >
			<id column="auno" property="auno" />
			<result column="auname" property="auname" />
			<result column="auintro" property="auintro" />
		</collection>
	</resultMap>

	<select id="bookSearchList" parameterType="dto.PageDTO" resultMap="book_and_author">
		select rownum, bc.*
		from(select rownum as rm, ac.*
		from(select b.*, a.*
		from  book b, book_author ba, author a
		where b.bno=ba.bno
		and a.auno=ba.auno
		and ba.bno in (
		            select bno 
		            from book 
		            where bname like '%' || #{searchWord} || '%'
		)
		or b.bno=ba.bno
		and a.auno=ba.auno
		and ba.auno in (
		            select auno 
		            from author 
		            where auname like '%' || #{searchWord} || '%'
		)
		<choose>
			<when test="sortgenre != 0">
				and gno = #{sortgenre}
			</when>
		</choose>
		<if test="sortkey==1">
			order by bupdate desc<!-- 날짜 순 -->
		</if>
		<if test="sortkey==2">
			order by bgrade desc<!-- 점수 순 -->
		</if>
		<if test="sortkey==3">
			order by bview desc<!-- 조회수 순 -->
		</if>
		)ac)bc
		<![CDATA[where bc.rm>=#{startRow} and bc.rm <=#{endRow}]]>
	</select>
	
	<select id="bookSearchCount" parameterType="string" resultType="int">
		select count(DISTINCT b.bno)
		from  book b, book_author ba, author a
		where b.bno=ba.bno
		and a.auno=ba.auno
		and ba.bno in (
		            select bno 
		            from book 
		            where bname like '%' || #{searchWord} || '%'
		)
		or b.bno=ba.bno
		and a.auno=ba.auno
		and ba.auno in (
		            select auno 
		            from author 
		            where auname like '%' || #{searchWord} || '%'
		)
		<choose>
			<when test="sortgenre != 0">
				and gno = #{sortgenre}
			</when>
		</choose>
	</select>
	
	<select id="bookList" parameterType="dto.PageDTO" resultType="dto.BookDTO">
		select rownum, b.*
		from(select rownum as rm, a.*
		from(select * from book
		<choose>
			<when test="sortgenre != 0">
				where gno = #{sortgenre}
			</when>
		</choose>
		<if test="sortkey==1">
			order by bupdate desc<!-- 날짜 순 -->
		</if>
		<if test="sortkey==2">
			order by bgrade desc<!-- 점수 순 -->
		</if>
		<if test="sortkey==3">
			order by bview desc<!-- 조회수 순 -->
		</if>
		<!-- 장르, 검색 -->
		<choose>
			<when test='sortgenre!=0 and searchWord==""'>
				where gno=#{sortgenre}
			</when>
			<when test='sortgenre==0 and searchWord!=""'>
				where bname like #{searchWord}
			</when>
			<when test='sortgenre!=0 and searchWord!=""'>
				where gno=#{sortgenre}
				and bname like #{searchWord}
			</when>
		</choose>
		<!-- 정렬방식 -->
		<choose>
			<when test="sortkey==1">
				order by bupdate<!-- 날짜 순 -->
			</when>
			<when test="sortkey==2">
				order by bgrade<!-- 점수 순 -->
			</when>
			<when test="sortkey==3">
				order by bview<!-- 조회수 순 -->
			</when>
		</choose>
		)a)b
		<![CDATA[where b.rm>=#{startRow} and b.rm <=#{endRow}]]>
	</select>
	
	<select id="bookCount" resultType="int">
		select count(*) from book
	</select>
	
	<select id="bookGenreCount" parameterType="int" resultType="int">
		select count(*) from book where gno = #{sortgenre}
	</select>
	
	<insert id="BookIns" parameterType="dto.BookDTO">
		insert into book
		values(book_bno_seq.nextval, #{bname}, #{gno}, sysdate, 0, 0, #{bthumb}, #{binfo})
	</insert>
	
	<resultMap type="dto.BookDTO" id="asdf" autoMapping="false" >
		<result column="bbno" property="bno" />
		<result column="bname" property="bname" />
		<result column="gno" property="gno" />
		<result column="bupdate" property="bupdate" />
		<result column="bgrade" property="bgrade" />
		<result column="bview" property="bview" />
		<result column="bthumb" property="bthumb" />
		<result column="binfo" property="binfo" />
		<collection property="sList" javaType="java.util.List"
			ofType="dto.SerialDTO"  autoMapping="false" >
			<id column="rno" property="rno" />
			<result column="upno" property="upno" />
			<result column="sbno" property="bno" />
			<result column="sdate" property="sdate" />
			<result column="scontent" property="scontent" />
			<result column="sprice" property="sprice" />
			<result column="ncount" property="ncount" />
			<result column="auno" property="auno" />
			<result column="stitle" property="stitle" />
			<result column="sgrade" property="sgrade" />
		</collection>
	</resultMap>
	
	<select id="bookDetail" parameterType="int" resultMap="asdf">
		select b.bno as bbno, b.*,  s.bno as sbno, s.*
		from book b, serial s
		where b.bno=s.bno(+)
		and b.bno=#{bno}
		order by s.upno desc
	</select>
	
	<select id="genreList" resultType="dto.GenreDTO">
		select * from genre order by gno
	</select>

</mapper>